<!DOCTYPE html>
<html class="dark" lang="pt-BR">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Stock OS - Minimal</title>
    
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>

    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { 
                        "primary": "#00c3ff", 
                        "background-dark": "#0a0a0f", 
                        "surface-dark": "#16161e", 
                        "status-green": "#00ff99", 
                        "status-red": "#ff3366", 
                        "status-yellow": "#ffd700",
                        "status-blue": "#3b82f6"
                    },
                    fontFamily: { "display": ["Space Grotesk", "sans-serif"] }
                }
            }
        }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        .glass-panel { backdrop-filter: blur(12px); background: rgba(22, 22, 30, 0.8); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .modal-backdrop {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal-backdrop.active { opacity: 1; }
        
        .modal-content {
            opacity: 0;
            transform: scale(0.95);
            transition: all 0.3s ease;
        }
        .modal-content.active {
            opacity: 1;
            transform: scale(1);
        }
        
        .card-hover { transition: all 0.2s ease; }
        .card-hover:hover { transform: translateY(-2px); }
        
        body.modal-open { overflow: hidden; }
        
        .progress-bar { transition: width 0.5s ease; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
    </style>
</head>

<body class="bg-[#0f1115] text-slate-100 min-h-screen flex flex-col font-display">

    <!-- Header -->
    <header class="sticky top-0 z-30 border-b border-white/5 w-full bg-[#16161e]">
        <div class="max-w-[1600px] mx-auto px-4 h-14 flex items-center justify-between gap-4">
            <div class="flex items-center gap-4 flex-shrink-0">
                <h1 class="text-lg font-bold tracking-tight text-white">Stock OS</h1>
                <span id="current-sector-label" class="text-[10px] uppercase tracking-[0.2em] text-primary font-bold">Carregando...</span>
            </div>

            <div class="flex-1 max-w-md mx-4">
                <div class="relative">
                    <input 
                        type="text" 
                        id="search-input" 
                        placeholder="Buscar por SKU ou nome..." 
                        oninput="filterItems(this.value)"
                        class="w-full h-9 pl-10 pr-4 bg-white/5 border border-white/10 rounded-lg text-sm focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary text-white placeholder:text-slate-500"
                    >
                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-[18px]">search</span>
                </div>
            </div>

            <div class="flex items-center gap-2 flex-shrink-0">
                <button onclick="toggleTheme()" class="size-9 flex items-center justify-center rounded-lg bg-white/5 border border-white/10 hover:bg-white/10 transition-colors">
                    <span class="material-symbols-outlined text-[18px] text-yellow-400">light_mode</span>
                </button>

                <button id="export-btn" onclick="exportToXLS()" class="hidden px-3 py-2 bg-status-green/10 hover:bg-status-green/20 border border-status-green/20 rounded-lg text-status-green text-xs font-bold uppercase tracking-widest transition-colors flex items-center gap-2">
                    <span class="material-symbols-outlined text-sm">download</span> XLS
                </button>

                <div class="relative">
                    <button onclick="toggleFilterMenu(event)" class="size-9 flex items-center justify-center rounded-lg bg-white/5 border border-white/10 hover:bg-white/10 transition-colors text-slate-300">
                        <span class="material-symbols-outlined text-[18px]">sort</span>
                        <span id="filter-indicator" class="absolute top-1 right-1 size-2 bg-primary rounded-full hidden"></span>
                    </button>
                    <div id="filter-menu" class="hidden absolute right-0 mt-2 w-48 bg-[#16161e] border border-white/10 rounded-xl shadow-2xl overflow-hidden z-50">
                        <div class="p-2 flex flex-col gap-1">
                            <span class="text-[10px] uppercase tracking-widest text-slate-500 px-3 py-2 font-bold">Ordenação</span>
                            <button onclick="applySort('default')" class="text-left w-full px-3 py-2 rounded hover:bg-white/5 text-sm text-slate-200">Padrão</button>
                            <button onclick="applySort('asc')" class="text-left w-full px-3 py-2 rounded hover:bg-white/5 text-sm text-status-red">Zerados Primeiro</button>
                            <button onclick="applySort('desc')" class="text-left w-full px-3 py-2 rounded hover:bg-white/5 text-sm text-status-green">Maior Saldo</button>
                        </div>
                    </div>
                </div>

                <button onclick="fetchData(currentTab, true)" class="size-9 flex items-center justify-center rounded-lg bg-white/5 border border-white/10 hover:bg-white/10 text-primary transition-colors">
                    <span class="material-symbols-outlined text-[18px]">sync</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Tabs -->
    <div class="border-b border-white/5 bg-[#0f1115]">
        <div class="max-w-[1600px] mx-auto px-4">
            <nav id="tabs-container" class="flex items-center gap-1 overflow-x-auto hide-scrollbar py-2"></nav>
        </div>
    </div>

    <!-- Main -->
    <main class="flex-1 p-6 pb-32 max-w-[1600px] mx-auto w-full space-y-6">
        <div class="flex items-center justify-between py-2">
            <div class="flex items-center gap-3">
                <div class="flex items-center gap-2" id="connection-status">
                    <span class="size-2 rounded-full bg-slate-400"></span>
                    <span class="text-[10px] font-bold uppercase tracking-widest text-slate-500">Conectando...</span>
                </div>
                <h3 id="page-title" class="text-xl font-bold tracking-tight text-white">Visão Geral</h3>
            </div>
            <div class="text-right">
                <span id="total-count" class="text-2xl font-bold text-white block leading-none">-</span>
                <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Itens</span>
            </div>
        </div>

        <div id="loading" class="flex flex-col items-center justify-center py-20">
            <div class="size-6 border-2 border-primary border-t-transparent rounded-full animate-spin mb-3"></div>
            <p class="text-xs uppercase tracking-widest text-slate-500">Carregando...</p>
        </div>

        <div id="error-msg" class="hidden p-6 rounded-xl bg-red-500/10 border border-red-500/20 text-center mx-auto max-w-lg">
            <p class="text-status-red font-bold">Falha na Conexão</p>
        </div>

        <div id="dynamic-content" class="flex flex-col gap-8 hidden"></div>
        
        <div id="no-results" class="hidden flex flex-col items-center justify-center py-20 text-slate-400 gap-3">
            <span class="material-symbols-outlined text-4xl">search_off</span>
            <p class="text-sm">Nenhum item encontrado</p>
        </div>
    </main>

    <!-- MODAL 1: Verificar Estoque -->
    <div id="stock-modal" class="fixed inset-0 z-[100] hidden">
        <div class="modal-backdrop absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeStockModal()"></div>
        <div class="relative z-10 flex items-center justify-center min-h-screen p-4 pointer-events-none">
            <div class="modal-content w-full max-w-2xl bg-[#16161e] border border-white/10 rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[85vh] pointer-events-auto">
                <div class="p-5 border-b border-white/5 flex justify-between items-center bg-white/5">
                    <div>
                        <h3 class="text-xl font-bold text-white" id="stock-modal-title">Verificar Estoque</h3>
                        <p class="text-sm text-slate-400 mt-1" id="stock-modal-subtitle">Selecione uma posição</p>
                    </div>
                    <button onclick="closeStockModal()" class="text-slate-400 hover:text-white transition-colors p-1 hover:bg-white/10 rounded-lg">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto custom-scrollbar p-0" id="stock-modal-body">
                    <div class="flex flex-col items-center justify-center h-48 gap-3 text-slate-500">
                        <span class="size-6 border-2 border-primary border-t-transparent rounded-full animate-spin"></span>
                        <span class="text-xs uppercase tracking-widest">Carregando...</span>
                    </div>
                </div>
                <div class="p-4 border-t border-white/5 bg-black/20">
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-slate-400">Total em posições:</span>
                        <span class="font-bold text-white" id="stock-total-qtd">0 UN</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL 2: Inventário -->
    <div id="inventory-modal" class="fixed inset-0 z-[110] hidden">
        <div class="modal-backdrop absolute inset-0 bg-black/90 backdrop-blur-sm" onclick="closeInventoryModal()"></div>
        <div class="relative z-10 flex items-center justify-center min-h-screen p-4 pointer-events-none">
            <div class="modal-content w-full max-w-lg bg-[#16161e] border border-white/10 rounded-2xl shadow-2xl overflow-hidden pointer-events-auto">
                <div class="p-5 border-b border-white/5 flex justify-between items-center bg-white/5">
                    <div>
                        <h3 class="text-lg font-bold text-white">Inventário</h3>
                        <p class="text-sm text-primary font-mono mt-0.5" id="inventory-modal-position">POSIÇÃO: --</p>
                    </div>
                    <button onclick="closeInventoryModal()" class="text-slate-400 hover:text-white transition-colors p-1 hover:bg-white/10 rounded-lg">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
                
                <div class="p-6 space-y-6">
                    <div class="flex justify-between items-start p-4 rounded-xl bg-white/5 border border-white/5">
                        <div class="flex-1 min-w-0 mr-4">
                            <p class="text-xs text-slate-500 uppercase tracking-wider mb-1">Item</p>
                            <p class="font-medium text-white text-sm truncate" id="inv-item-name">--</p>
                            <p class="text-xs text-slate-500 font-mono mt-0.5" id="inv-item-sku">--</p>
                        </div>
                        <div class="text-right flex-shrink-0">
                            <p class="text-xs text-slate-500 uppercase tracking-wider mb-1">Sistema</p>
                            <p class="text-3xl font-bold text-white" id="inv-system-qtd">--</p>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <div class="flex justify-between text-xs text-slate-500 uppercase tracking-wider">
                            <span>Sistema</span>
                            <span id="inv-system-pct">0%</span>
                        </div>
                        <div class="relative w-full bg-black/40 h-3 rounded-full overflow-hidden">
                            <div id="inv-system-bar" class="h-full rounded-full bg-primary transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <label class="text-xs uppercase tracking-wider text-slate-500 font-bold">Contagem Física na Posição</label>
                        <div class="flex gap-3">
                            <input 
                                type="number" 
                                id="inv-input-count"
                                placeholder="0"
                                min="0"
                                step="1"
                                class="flex-1 h-14 px-4 bg-black/30 border-2 border-white/10 rounded-xl text-2xl font-bold text-center focus:outline-none focus:border-primary text-white placeholder:text-slate-500"
                                oninput="updateInventoryPreview()"
                            >
                            <button onclick="saveInventoryByPosition()" class="h-14 px-6 bg-status-green hover:bg-status-green/80 text-black font-bold rounded-xl transition-colors flex items-center gap-2 shadow-lg shadow-status-green/20">
                                <span class="material-symbols-outlined">check</span>
                                <span class="hidden sm:inline">Salvar</span>
                            </button>
                        </div>
                    </div>

                    <div id="inv-preview" class="hidden p-4 rounded-xl bg-white/5 border border-white/5 space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-slate-400">Contagem informada:</span>
                            <span class="text-xl font-bold text-primary" id="inv-physical-display">0</span>
                        </div>
                        
                        <div class="space-y-1">
                            <div class="flex justify-between text-[10px] text-slate-500 uppercase">
                                <span>Contagem Física</span>
                                <span id="inv-physical-pct">0%</span>
                            </div>
                            <div class="relative w-full bg-black/40 h-2 rounded-full overflow-hidden">
                                <div id="inv-physical-bar" class="h-full rounded-full bg-status-green transition-all duration-500" style="width: 0%"></div>
                            </div>
                        </div>

                        <div class="flex justify-between items-center pt-2 border-t border-white/10">
                            <span class="text-sm text-slate-400">Diferença:</span>
                            <span class="text-xl font-bold text-status-green" id="inv-diff-display">0</span>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <p class="text-xs uppercase tracking-wider text-slate-500 font-bold">Histórico desta posição</p>
                        <div id="inv-history" class="space-y-2 max-h-32 overflow-y-auto custom-scrollbar p-2 rounded-lg bg-black/20 border border-white/5">
                            <p class="text-sm text-slate-400 italic text-center py-2">Nenhuma contagem registrada</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURAÇÃO
        const SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbxxVFRDZGLNahToyaR85VEsqvUYngie3Tqy4LCGeY_PV2-ZTbvytTTDFeSq8gO3NvF_/exec';
        
        const FAMILIES_CONFIG = [
            { code: '20.006', title: 'Família 20.006' },
            { code: '89.004', title: 'Família 89.004' },
            { code: '89.005', title: 'Família 89.005' },
            { code: '20.003', title: 'Junta 20.003' },
            { code: '10.004', title: 'Família 10.004' }
        ];

        const SECTORS = [
            "Alertas",
            "Injeção Plástico", "Injeção Alumínio", "Torno", "Fresa", 
            "Montagem Manual", "Montagem Automática", "Manutenção", "Logística"
        ];
        
        let currentTab = SECTORS[1];
        let currentSort = 'default';
        let cachedData = [];
        let filteredData = [];
        let isFirstLoad = true;
        let inventoryData = {};
        let currentInventoryContext = {};

        // ELEMENTOS
        const tabsContainer = document.getElementById('tabs-container');
        const container = document.getElementById('dynamic-content');
        const loading = document.getElementById('loading');
        const errorDiv = document.getElementById('error-msg');
        const noResults = document.getElementById('no-results');
        const totalCount = document.getElementById('total-count');
        const connStatus = document.getElementById('connection-status');
        const pageTitle = document.getElementById('page-title');
        const sectorLabel = document.getElementById('current-sector-label');
        const filterMenu = document.getElementById('filter-menu');
        const filterIndicator = document.getElementById('filter-indicator');
        const exportBtn = document.getElementById('export-btn');
        const searchInput = document.getElementById('search-input');

        // FUNÇÕES DE MODAL
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            const backdrop = modal.querySelector('.modal-backdrop');
            const content = modal.querySelector('.modal-content');
            
            modal.classList.remove('hidden');
            document.body.classList.add('modal-open');
            
            requestAnimationFrame(() => {
                backdrop.classList.add('active');
                content.classList.add('active');
            });
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            const backdrop = modal.querySelector('.modal-backdrop');
            const content = modal.querySelector('.modal-content');
            
            backdrop.classList.remove('active');
            content.classList.remove('active');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                if (!document.querySelector('.modal-backdrop.active')) {
                    document.body.classList.remove('modal-open');
                }
            }, 300);
        }

        // MODAL ESTOQUE
        async function openStockModal(sku) {
            console.log('Abrindo estoque:', sku);
            
            const item = cachedData.find(i => i.sku === sku);
            if (!item) {
                console.error('Item não encontrado');
                return;
            }

            document.getElementById('stock-modal-title').innerText = item.nome || 'Verificar Estoque';
            document.getElementById('stock-modal-subtitle').innerText = `SKU: ${sku}`;
            
            document.getElementById('stock-modal-body').innerHTML = `
                <div class="flex flex-col items-center justify-center h-48 gap-3 text-slate-500">
                    <span class="size-6 border-2 border-primary border-t-transparent rounded-full animate-spin"></span>
                    <span class="text-xs uppercase tracking-widest">Buscando posições...</span>
                </div>`;
            
            openModal('stock-modal');

            try {
                const url = `${SHEET_API_URL}?type=details&sku=${encodeURIComponent(sku)}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) throw new Error(data.message);
                
                renderStockPositions(sku, item, data);
            } catch (error) {
                console.error('Erro:', error);
                document.getElementById('stock-modal-body').innerHTML = `
                    <div class="flex flex-col items-center justify-center h-48 text-status-red gap-2">
                        <span class="material-symbols-outlined text-3xl">error</span>
                        <p class="text-sm">Erro ao carregar posições</p>
                    </div>`;
            }
        }

        function renderStockPositions(sku, item, positions) {
            const body = document.getElementById('stock-modal-body');
            
            if (!positions || positions.length === 0) {
                body.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-48 text-slate-500 gap-2">
                        <span class="material-symbols-outlined text-3xl">inventory_2</span>
                        <p class="text-sm">Nenhuma posição encontrada</p>
                    </div>`;
                document.getElementById('stock-total-qtd').innerText = '0 UN';
                return;
            }

            let total = 0;
            let html = '<div class="divide-y divide-white/5">';

            positions.forEach((pos, idx) => {
                const qtd = Number(pos.qtd) || 0;
                total += qtd;
                const physical = (inventoryData[sku] && inventoryData[sku][pos.loc]) || 0;
                const hasInv = physical > 0;
                
                html += `
                    <div onclick="openInventoryModal('${sku}', '${pos.loc}', ${qtd})" 
                         class="p-4 hover:bg-white/5 cursor-pointer transition-colors group">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <div class="size-10 rounded-lg bg-primary/10 border border-primary/20 flex items-center justify-center text-primary font-bold">
                                    ${idx + 1}
                                </div>
                                <div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-primary font-bold font-mono text-lg">${pos.loc || 'S/LOC'}</span>
                                        ${hasInv ? `<span class="text-[10px] bg-status-green/10 text-status-green border border-status-green/20 px-1.5 py-0.5 rounded-full">OK</span>` : ''}
                                    </div>
                                    <span class="text-xs text-slate-500 font-mono">Lote: ${pos.lote || '-'}</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="block text-2xl font-bold text-white">${qtd.toLocaleString('pt-BR')}</span>
                                <span class="text-xs text-slate-500">${pos.un || 'UN'}</span>
                            </div>
                        </div>
                    </div>`;
            });

            html += '</div>';
            body.innerHTML = html;
            document.getElementById('stock-total-qtd').innerText = `${total.toLocaleString('pt-BR')} ${positions[0]?.un || 'UN'}`;
        }

        function closeStockModal() {
            closeModal('stock-modal');
        }

        // MODAL INVENTÁRIO
        function openInventoryModal(sku, position, systemQtd) {
            const item = cachedData.find(i => i.sku === sku);
            if (!item) return;

            currentInventoryContext = { sku, position, systemQtd, item };
            
            document.getElementById('inventory-modal-position').innerText = `POSIÇÃO: ${position}`;
            document.getElementById('inv-item-name').innerText = item.nome || 'Sem nome';
            document.getElementById('inv-item-sku').innerText = sku;
            document.getElementById('inv-system-qtd').innerText = systemQtd.toLocaleString('pt-BR');
            
            const cap = Number(item.capacidade) || 1000;
            const pct = Math.min((systemQtd / cap) * 100, 100);
            document.getElementById('inv-system-pct').innerText = `${Math.round(pct)}%`;
            document.getElementById('inv-system-bar').style.width = `${pct}%`;
            
            const existing = (inventoryData[sku] && inventoryData[sku][position]) || 0;
            document.getElementById('inv-input-count').value = existing || '';
            
            if (existing) {
                updateInventoryPreview();
            } else {
                document.getElementById('inv-preview').classList.add('hidden');
            }
            
            openModal('inventory-modal');
        }

        function updateInventoryPreview() {
            const val = parseFloat(document.getElementById('inv-input-count').value) || 0;
            const system = currentInventoryContext.systemQtd;
            
            if (val <= 0) {
                document.getElementById('inv-preview').classList.add('hidden');
                return;
            }
            
            document.getElementById('inv-preview').classList.remove('hidden');
            document.getElementById('inv-physical-display').innerText = val.toLocaleString('pt-BR');
            
            const cap = Number(currentInventoryContext.item?.capacidade) || 1000;
            const pct = Math.min((val / cap) * 100, 100);
            document.getElementById('inv-physical-pct').innerText = `${Math.round(pct)}%`;
            document.getElementById('inv-physical-bar').style.width = `${pct}%`;
            
            const diff = val - system;
            const diffEl = document.getElementById('inv-diff-display');
            diffEl.innerText = (diff > 0 ? '+' : '') + diff.toLocaleString('pt-BR');
            diffEl.className = `text-xl font-bold ${diff < 0 ? 'text-status-red' : diff > 0 ? 'text-status-blue' : 'text-status-green'}`;
        }

        function saveInventoryByPosition() {
            const val = parseFloat(document.getElementById('inv-input-count').value);
            if (isNaN(val) || val < 0) {
                alert('Digite uma quantidade válida!');
                return;
            }
            
            const { sku, position } = currentInventoryContext;
            if (!inventoryData[sku]) inventoryData[sku] = {};
            inventoryData[sku][position] = val;
            
            const btn = event.target.closest('button');
            const original = btn.innerHTML;
            btn.innerHTML = '<span class="material-symbols-outlined">check</span> Salvo!';
            
            setTimeout(() => {
                btn.innerHTML = original;
                closeInventoryModal();
                setTimeout(() => openStockModal(sku), 350);
            }, 800);
        }

        function closeInventoryModal() {
            closeModal('inventory-modal');
        }

        // OUTRAS FUNÇÕES
        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
        }

        function toggleFilterMenu(e) {
            e.stopPropagation();
            filterMenu.classList.toggle('hidden');
        }

        function applySort(type) {
            currentSort = type;
            filterIndicator.classList.toggle('hidden', type === 'default');
            filterMenu.classList.add('hidden');
            container.innerHTML = '';
            processAndRender(filteredData.length > 0 ? filteredData : cachedData);
        }

        function filterItems(term) {
            if (!term) {
                filteredData = [...cachedData];
            } else {
                const t = term.toLowerCase();
                filteredData = cachedData.filter(i => 
                    (i.sku && i.sku.toLowerCase().includes(t)) ||
                    (i.nome && i.nome.toLowerCase().includes(t))
                );
            }
            
            container.innerHTML = '';
            if (filteredData.length === 0) {
                noResults.classList.remove('hidden');
                totalCount.innerText = '0';
            } else {
                noResults.classList.add('hidden');
                processAndRender(filteredData);
            }
        }

        function sortItems(items) {
            if (currentSort === 'default') return items;
            return [...items].sort((a, b) => {
                const qa = Number(a.qtd) || 0;
                const qb = Number(b.qtd) || 0;
                return currentSort === 'asc' ? qa - qb : qb - qa;
            });
        }

        function renderTabs() {
            tabsContainer.innerHTML = '';
            SECTORS.forEach(sector => {
                const btn = document.createElement('button');
                const active = sector === currentTab;
                const alertTab = sector === "Alertas";
                
                let cls = active 
                    ? 'px-4 py-1.5 text-sm font-bold bg-primary/10 rounded-full border border-primary/20 text-primary'
                    : 'px-4 py-1.5 text-sm font-medium text-slate-400 hover:text-white rounded-full hover:bg-white/5';
                
                if (alertTab && active) cls = 'px-4 py-1.5 text-sm font-bold bg-status-red/10 rounded-full border border-status-red/20 text-status-red';
                else if (alertTab) cls = 'px-4 py-1.5 text-sm font-medium text-status-red hover:bg-status-red/5 rounded-full flex items-center gap-1.5';

                btn.className = cls;
                btn.innerHTML = alertTab && !active ? '<span class="material-symbols-outlined text-sm">warning</span> Alertas' : sector;
                
                btn.onclick = () => {
                    currentTab = sector;
                    isFirstLoad = true;
                    container.innerHTML = '';
                    searchInput.value = '';
                    filteredData = [];
                    renderTabs();
                    fetchData(sector, true);
                };
                tabsContainer.appendChild(btn);
            });
        }

        async function fetchData(tabName = currentTab, force = false) {
            if (tabName === "Alertas") exportBtn.classList.remove('hidden');
            else exportBtn.classList.add('hidden');

            if (force || isFirstLoad) {
                loading.classList.remove('hidden');
                container.classList.add('hidden');
                noResults.classList.add('hidden');
                errorDiv.classList.add('hidden');
            }
            
            pageTitle.innerText = tabName === "Alertas" ? "Itens Críticos" : tabName;
            sectorLabel.innerText = tabName;
            connStatus.innerHTML = '<span class="size-2 rounded-full bg-yellow-500 animate-pulse"></span><span class="text-[10px] font-bold uppercase tracking-widest text-yellow-500">Sincronizando...</span>';

            try {
                const url = `${SHEET_API_URL}?tab=${encodeURIComponent(tabName)}`;
                const res = await fetch(url);
                const data = await res.json();
                if (data.error) throw new Error(data.message);
                
                cachedData = data;
                filteredData = [...data];
                processAndRender(data);
                totalCount.innerText = data.length;
                connStatus.innerHTML = '<span class="size-2 rounded-full bg-status-green shadow-[0_0_8px_#00ff99]"></span><span class="text-[10px] font-bold uppercase tracking-widest text-status-green">Online</span>';
                isFirstLoad = false;
            } catch (err) {
                console.error(err);
                if (isFirstLoad) {
                    loading.classList.add('hidden');
                    errorDiv.classList.remove('hidden');
                }
                connStatus.innerHTML = '<span class="size-2 rounded-full bg-status-red"></span><span class="text-[10px] font-bold uppercase tracking-widest text-status-red">Offline</span>';
            }
        }

        function processAndRender(items) {
            loading.classList.add('hidden');
            container.classList.remove('hidden');

            if (items.length === 0) {
                noResults.classList.remove('hidden');
                return;
            }

            noResults.classList.add('hidden');
            const grouped = {};
            FAMILIES_CONFIG.forEach(f => grouped[f.code] = []);
            grouped['OUTROS'] = [];

            items.forEach(item => {
                const sku = String(item.sku).trim();
                let found = false;
                for (let f of FAMILIES_CONFIG) {
                    if (sku.startsWith(f.code)) {
                        grouped[f.code].push(item);
                        found = true;
                        break;
                    }
                }
                if (!found) grouped['OUTROS'].push(item);
            });

            FAMILIES_CONFIG.forEach(f => {
                if (grouped[f.code].length > 0) renderSection(f.code, f.title, sortItems(grouped[f.code]));
            });
            
            if (grouped['OUTROS'].length > 0) renderSection('OUTROS', 'Outros', sortItems(grouped['OUTROS']));
        }

        function renderSection(id, title, items) {
            let sec = document.getElementById(`sec-${id}`);
            let grid;
            
            if (!sec) {
                sec = document.createElement('section');
                sec.id = `sec-${id}`;
                sec.innerHTML = `
                    <div class="flex items-center justify-between mb-4 pb-2 border-b border-white/5">
                        <h4 class="text-xs font-bold uppercase tracking-widest text-slate-400">${title}</h4>
                        <span class="text-[10px] font-mono text-slate-500">${items.length} itens</span>
                    </div>`;
                grid = document.createElement('div');
                grid.id = `grid-${id}`;
                grid.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3";
                sec.appendChild(grid);
                container.appendChild(sec);
            } else {
                grid = document.getElementById(`grid-${id}`);
            }
            
            items.forEach(item => grid.appendChild(createCard(item)));
        }

        function createCard(item) {
            const vis = calculateVisuals(item);
            const positions = inventoryData[item.sku] || {};
            const physTotal = Object.values(positions).reduce((a,b) => a+b, 0);
            const hasInv = physTotal > 0;
            const sysTotal = Number(item.qtd) || 0;
            const diff = physTotal - sysTotal;
            
            const cap = Number(item.capacidade) || (Number(item.minimo) > 0 ? Number(item.minimo) * 3 : 1000);
            const sysPct = Math.min((sysTotal / cap) * 100, 100);
            const physPct = Math.min((physTotal / cap) * 100, 100);
            
            const el = document.createElement('div');
            el.id = `card-${item.sku}`;
            el.className = `relative bg-[#16161e] border border-white/5 rounded-xl overflow-hidden card-hover ${vis.theme.glow}`;
            
            const invBadge = hasInv ? `
                <div class="absolute top-3 left-3">
                    <span class="text-[9px] bg-status-green/10 text-status-green border border-status-green/20 px-2 py-0.5 rounded-full font-bold flex items-center gap-1">
                        <span class="material-symbols-outlined text-[10px]">check_circle</span>
                        ${Object.keys(positions).length} pos.
                    </span>
                </div>
            ` : '';
            
            let physColor = 'bg-white/10';
            if (hasInv) {
                if (Math.abs(diff) <= sysTotal * 0.05) physColor = 'bg-status-green';
                else if (diff < 0) physColor = 'bg-status-red';
                else physColor = 'bg-status-blue';
            }

            el.innerHTML = `
                <div class="p-4">
                    ${invBadge}
                    <div class="flex flex-col gap-3 ${hasInv ? 'pt-6' : ''}">
                        <div class="flex justify-between items-start ${hasInv ? 'pr-0' : 'pr-12'}">
                            <div class="overflow-hidden">
                                <h4 class="text-white text-base font-medium leading-tight truncate pr-2" title="${item.nome}">${item.nome || 'Sem Nome'}</h4>
                                <p class="text-slate-500 text-xs font-mono mt-0.5">${item.sku}</p>
                            </div>
                        </div>
                        
                        <div class="flex items-end justify-between">
                            <div class="flex items-baseline gap-1">
                                <span class="text-3xl font-bold text-white tracking-tight ${vis.status === 'CRÍTICO' ? 'text-status-red' : ''}">${vis.qtd.toLocaleString('pt-BR')}</span>
                                <span class="text-xs text-slate-500 font-medium">${item.unidade || 'UN'}</span>
                            </div>
                            <span class="${vis.theme.color} text-[10px] font-bold px-2 py-1 rounded-full bg-black/30 border border-white/5">${vis.status}</span>
                        </div>

                        <div class="space-y-1">
                            <div class="flex justify-between text-[9px] text-slate-500 uppercase tracking-wider">
                                <span>Sistema</span>
                                <span>${Math.round(sysPct)}%</span>
                            </div>
                            <div class="relative w-full bg-black/40 h-2 rounded-full overflow-hidden">
                                <div class="${vis.theme.bar} h-full rounded-full progress-bar" style="width: ${sysPct}%"></div>
                                ${vis.minStock > 0 ? `<div class="absolute top-0 bottom-0 w-0.5 bg-white/50 z-10" style="left: ${vis.minPct}%"></div>` : ''}
                            </div>
                        </div>

                        ${hasInv ? `
                        <div class="space-y-1">
                            <div class="flex justify-between text-[9px] uppercase tracking-wider">
                                <span class="text-slate-500">Contagem Física</span>
                                <span class="${diff < 0 ? 'text-status-red' : diff > 0 ? 'text-status-blue' : 'text-status-green'} font-bold">${Math.round(physPct)}%</span>
                            </div>
                            <div class="relative w-full bg-black/40 h-2 rounded-full overflow-hidden border border-dashed border-white/10">
                                <div class="${physColor} h-full rounded-full progress-bar" style="width: ${physPct}%"></div>
                            </div>
                            <div class="flex justify-between text-[10px]">
                                <span class="text-slate-500">Total: <span class="font-bold text-slate-300">${physTotal}</span></span>
                                <span class="${diff < 0 ? 'text-status-red' : diff > 0 ? 'text-status-blue' : 'text-status-green'} font-bold">Dif: ${diff > 0 ? '+' : ''}${diff}</span>
                            </div>
                        </div>
                        ` : ''}

                        <button onclick="openStockModal('${item.sku}')" class="mt-1 w-full py-2.5 rounded-lg bg-white/5 hover:bg-white/10 border border-white/5 text-slate-300 text-xs font-bold uppercase tracking-wider transition-colors flex items-center justify-center gap-2">
                            <span class="material-symbols-outlined text-sm">inventory_2</span> 
                            Verificar Estoque
                        </button>
                    </div>
                </div>`;
            
            return el;
        }

        function calculateVisuals(item) {
            const qtd = Number(item.qtd) || 0;
            const minStock = Number(item.minimo) || 0;
            const cap = Number(item.capacidade) || (minStock > 0 ? minStock * 3 : 1000);
            
            let status = "OK";
            let theme = { color: 'text-status-green', glow: 'hover:shadow-[0_0_20px_rgba(0,255,153,0.1)]', bar: 'bg-status-green' };

            if (currentTab === "Alertas" || item.status?.includes("CRIT")) {
                status = "CRÍTICO";
                theme = { color: 'text-status-red', glow: 'shadow-[0_0_20px_rgba(255,51,102,0.15)] border-status-red/30', bar: 'bg-status-red' };
            } else if (minStock > 0 && qtd <= minStock) {
                status = "CRÍTICO";
                theme = { color: 'text-status-red', glow: 'shadow-[0_0_20px_rgba(255,51,102,0.15)]', bar: 'bg-status-red' };
            } else if (minStock > 0 && qtd <= minStock * 1.2) {
                status = "ATENÇÃO";
                theme = { color: 'text-status-yellow', glow: 'border-status-yellow/30', bar: 'bg-status-yellow' };
            }
            
            return { qtd, minStock, status, theme, pct: Math.min((qtd/cap)*100, 100), minPct: Math.min((minStock/cap)*100, 100) };
        }

        function exportToXLS() {
            alert('Exportação em desenvolvimento');
        }

        // INICIALIZAÇÃO
        renderTabs();
        fetchData(currentTab);
        setInterval(() => fetchData(currentTab), 30000);
    </script>
</body>
</html>
